/**
 * ShoppingList Controller
 * Xử lý logic cho quản lý danh sách mua sắm
 */

const ShoppingList = require('../models/ShoppingList.model');
const FridgeItem = require('../models/FridgeItem.model');
const notificationService = require('../services/notification.service');
// Require các models liên quan để Mongoose có thể populate
require('../models/FoodItem.model');
require('../models/Unit.model');

/**
 * @desc    Tạo danh sách mua sắm tự động từ FridgeItem
 * @route   POST /api/shopping-lists/auto
 * @access  Private
 * 
 * Luồng nghiệp vụ:
 * 1. Lấy FridgeItem của user với status: expired, used_up, expiring_soon
 * 2. Nếu user đã có shopping list status = "draft" → update lại items
 * 3. Nếu chưa có → tạo mới
 * 4. Nếu không có item phù hợp → trả message
 */
exports.createAutoShoppingList = async (req, res, next) => {
  try {
    const userId = req.user.id;

    // Lấy FridgeItem của user với các status cần thiết
    const fridgeItems = await FridgeItem.find({
      userId: userId,
      status: { $in: ['expired', 'used_up', 'expiring_soon'] }
    })
      .populate('foodItemId', 'name categoryId')
      .populate('unitId', 'name abbreviation');

    // Chuyển đổi FridgeItem thành ShoppingListItem
    // Filter và map, chỉ lấy items có foodItemId và unitId hợp lệ
    const items = fridgeItems
      .filter(fridgeItem => fridgeItem.foodItemId && fridgeItem.unitId)
      .map(fridgeItem => ({
        foodItemId: fridgeItem.foodItemId._id,
        unitId: fridgeItem.unitId._id,
        quantity: 1, // Default quantity = 1
        reason: fridgeItem.status, // expired, used_up, hoặc expiring_soon
        isBought: false,
        categoryId: fridgeItem.foodItemId?.categoryId || null
      }));

    // Nếu không có item phù hợp sau khi filter
    if (items.length === 0) {
      return res.json({
        success: true,
        message: 'Không có thực phẩm nào cần mua. Tủ lạnh của bạn đang ổn!',
        data: {
          shoppingList: null,
          itemsCount: 0
        }
      });
    }

    // Kiểm tra xem user đã có shopping list status = "draft" chưa
    let shoppingList = await ShoppingList.findOne({
      userId: userId,
      status: 'draft',
      isAutoGenerated: true
    });

    if (shoppingList) {
      // Update lại items
      shoppingList.items = items;
      shoppingList.name = `Danh sách đi chợ tự động - ${new Date().toLocaleDateString('vi-VN')}`;
      await shoppingList.save();
      
      await shoppingList.populate([
        { path: 'items.foodItemId', select: 'name categoryId image' },
        { path: 'items.unitId', select: 'name abbreviation' }
      ]);

      return res.json({
        success: true,
        message: 'Đã cập nhật danh sách đi chợ tự động',
        data: {
          shoppingList,
          itemsCount: items.length,
          isUpdated: true
        }
      });
    } else {
      // Tạo mới
      shoppingList = await ShoppingList.create({
        userId: userId,
        name: `Danh sách đi chợ tự động - ${new Date().toLocaleDateString('vi-VN')}`,
        items: items,
        status: 'draft',
        isAutoGenerated: true
      });

      await shoppingList.populate([
        { path: 'items.foodItemId', select: 'name categoryId image' },
        { path: 'items.unitId', select: 'name abbreviation' }
      ]);

      return res.status(201).json({
        success: true,
        message: 'Đã tạo danh sách đi chợ tự động thành công',
        data: {
          shoppingList,
          itemsCount: items.length,
          isUpdated: false
        }
      });
    }
  } catch (error) {
    next(error);
  }
};

/**
 * @desc    Lấy danh sách mua sắm của user
 * @route   GET /api/shopping-lists
 * @access  Private
 * 
 * Luồng nghiệp vụ:
 * 1. Lấy userId từ req.user (từ auth middleware)
 * 2. Query ShoppingList của user
 * 3. Populate thông tin FoodItem (name)
 * 4. Sort mới nhất trước
 * 5. Trả về danh sách
 */
exports.getShoppingLists = async (req, res, next) => {
  try {
    const userId = req.user.id;

    const shoppingLists = await ShoppingList.find({ userId })
      .populate('items.foodItemId', 'name image')
      .populate('items.unitId', 'name abbreviation')
      .sort({ createdAt: -1 }); // Mới nhất trước

    res.json({
      success: true,
      count: shoppingLists.length,
      data: {
        shoppingLists
      }
    });
  } catch (error) {
    next(error);
  }
};

/**
 * @desc    Lấy chi tiết danh sách mua sắm
 * @route   GET /api/shopping-lists/:id
 * @access  Private
 */
exports.getShoppingListById = async (req, res, next) => {
  try {
    const shoppingList = await ShoppingList.findOne({
      _id: req.params.id,
      userId: req.user.id
    })
      .populate('items.foodItemId', 'name categoryId image')
      .populate('items.unitId', 'name abbreviation');

    if (!shoppingList) {
      return res.status(404).json({
        success: false,
        message: 'Không tìm thấy danh sách mua sắm'
      });
    }

    res.json({
      success: true,
      data: {
        shoppingList
      }
    });
  } catch (error) {
    next(error);
  }
};

/**
 * @desc    Cập nhật item trong shopping list (quantity hoặc isBought)
 * @route   PUT /api/shopping-lists/:id/item/:itemId
 * @access  Private
 * 
 * Luồng nghiệp vụ:
 * 1. Tìm shopping list của user
 * 2. Tìm item trong items array
 * 3. Update quantity hoặc isBought
 * 4. Lưu và trả về
 */
exports.updateShoppingListItem = async (req, res, next) => {
  try {
    const { id, itemId } = req.params;
    const { quantity, isBought } = req.body;

    // Tìm shopping list
    const shoppingList = await ShoppingList.findOne({
      _id: id,
      userId: req.user.id
    });

    if (!shoppingList) {
      return res.status(404).json({
        success: false,
        message: 'Không tìm thấy danh sách mua sắm'
      });
    }

    // Tìm item trong array
    const item = shoppingList.items.id(itemId);
    if (!item) {
      return res.status(404).json({
        success: false,
        message: 'Không tìm thấy item trong danh sách'
      });
    }

    // Update fields
    if (quantity !== undefined) {
      item.quantity = quantity;
    }
    if (isBought !== undefined) {
      item.isBought = isBought;
    }

    await shoppingList.save();

    // Populate để trả về đầy đủ thông tin
    await shoppingList.populate([
      { path: 'items.foodItemId', select: 'name categoryId image' },
      { path: 'items.unitId', select: 'name abbreviation' }
    ]);

    res.json({
      success: true,
      message: 'Đã cập nhật item thành công',
      data: {
        shoppingList,
        updatedItem: item
      }
    });
  } catch (error) {
    next(error);
  }
};

/**
 * @desc    Hoàn thành danh sách mua sắm
 * @route   PUT /api/shopping-lists/:id/complete
 * @access  Private
 * 
 * Luồng nghiệp vụ:
 * 1. Tìm shopping list của user
 * 2. Với mỗi item có isBought = true:
 *    - Kiểm tra xem đã có FridgeItem với cùng userId, foodItemId, expiryDate chưa
 *    - Nếu có: tăng quantity
 *    - Nếu chưa: tạo mới FridgeItem với source = "shopping_list"
 *    - Tự động cập nhật status dựa trên expiryDate
 * 3. Chuyển status shopping list sang "completed"
 * 4. Set completedAt = hiện tại
 * 5. Lưu và trả về
 */
exports.completeShoppingList = async (req, res, next) => {
  try {
    const userId = req.user.id;

    // Tìm shopping list của user
    const shoppingList = await ShoppingList.findOne({
      _id: req.params.id,
      userId: userId
    })
      .populate('items.foodItemId', 'name')
      .populate('items.unitId', 'name');

    if (!shoppingList) {
      return res.status(404).json({
        success: false,
        message: 'Không tìm thấy danh sách mua sắm'
      });
    }

    if (shoppingList.status === 'completed') {
      return res.status(400).json({
        success: false,
        message: 'Danh sách đã được hoàn thành rồi'
      });
    }

    // Lọc các items đã mua (isBought = true)
    const boughtItems = shoppingList.items.filter(item => item.isBought === true);

    if (boughtItems.length === 0) {
      return res.status(400).json({
        success: false,
        message: 'Chưa có item nào được đánh dấu là đã mua. Vui lòng đánh dấu các item đã mua trước khi hoàn thành.'
      });
    }

    // Xử lý từng item đã mua
    const fridgeItemsCreated = [];
    const fridgeItemsUpdated = [];

    for (const item of boughtItems) {
      // Validate item có foodItemId và unitId hợp lệ
      if (!item.foodItemId || !item.unitId) {
        console.warn(`Skipping item with invalid foodItemId or unitId: ${item._id}`);
        continue;
      }

      // Tính expiryDate: sử dụng expiryDate từ item nếu có, nếu không thì mặc định 7 ngày từ bây giờ
      let expiryDate;
      if (item.expiryDate) {
        expiryDate = new Date(item.expiryDate);
      } else {
        // Default: 7 ngày từ bây giờ
        expiryDate = new Date();
        expiryDate.setDate(expiryDate.getDate() + 7);
      }

      // Kiểm tra xem đã có FridgeItem với cùng userId, foodItemId, expiryDate chưa
      // (và status không phải 'used_up')
      const existingFridgeItem = await FridgeItem.findOne({
        userId: userId,
        foodItemId: item.foodItemId._id,
        expiryDate: expiryDate,
        status: { $ne: 'used_up' }
      })
        .populate('foodItemId', 'name')
        .populate('unitId', 'name abbreviation');

      if (existingFridgeItem) {
        // Tăng quantity
        existingFridgeItem.quantity += item.quantity;
        // Cập nhật status tự động dựa trên expiryDate
        existingFridgeItem.updateStatus();
        await existingFridgeItem.save();
        
        fridgeItemsUpdated.push({
          fridgeItemId: existingFridgeItem._id,
          foodItemId: existingFridgeItem.foodItemId._id,
          foodItemName: existingFridgeItem.foodItemId.name,
          unitId: existingFridgeItem.unitId._id,
          unitName: existingFridgeItem.unitId.name,
          newQuantity: existingFridgeItem.quantity,
          status: existingFridgeItem.status
        });
      } else {
        // Tạo mới FridgeItem
        const newFridgeItem = await FridgeItem.create({
          userId: userId,
          foodItemId: item.foodItemId._id,
          quantity: item.quantity,
          unitId: item.unitId._id,
          expiryDate: expiryDate,
          source: 'shopping_list',
          sourceShoppingListId: shoppingList._id,
          purchaseDate: new Date(),
          // Status sẽ được tự động cập nhật bởi updateStatus()
        });

        // Cập nhật status tự động
        newFridgeItem.updateStatus();
        await newFridgeItem.save();

        // Populate để lấy tên
        await newFridgeItem.populate('foodItemId', 'name');
        await newFridgeItem.populate('unitId', 'name abbreviation');

        fridgeItemsCreated.push({
          fridgeItemId: newFridgeItem._id,
          foodItemId: newFridgeItem.foodItemId._id,
          foodItemName: newFridgeItem.foodItemId.name,
          unitId: newFridgeItem.unitId._id,
          unitName: newFridgeItem.unitId.name,
          quantity: newFridgeItem.quantity,
          status: newFridgeItem.status
        });
      }
    }

    // Chuyển status shopping list sang completed
    shoppingList.status = 'completed';
    shoppingList.completedAt = new Date();
    await shoppingList.save();

    // Populate để trả về đầy đủ thông tin
    await shoppingList.populate([
      { path: 'items.foodItemId', select: 'name categoryId image' },
      { path: 'items.unitId', select: 'name abbreviation' }
    ]);

    res.json({
      success: true,
      message: 'Đã hoàn thành danh sách mua sắm và thêm thực phẩm vào tủ lạnh',
      data: {
        shoppingList,
        fridgeItemsCreated: fridgeItemsCreated.length,
        fridgeItemsUpdated: fridgeItemsUpdated.length,
        details: {
          created: fridgeItemsCreated,
          updated: fridgeItemsUpdated
        }
      }
    });
  } catch (error) {
    console.error('Error in completeShoppingList:', error);
    next(error);
  }
};

/**
 * @desc    Tạo danh sách mua sắm mới (manual)
 * @route   POST /api/shopping-lists
 * @access  Private
 */
exports.createShoppingList = async (req, res, next) => {
  try {
    const { name, items, plannedDate } = req.body;

    const shoppingList = await ShoppingList.create({
      userId: req.user.id,
      name: name || `Danh sách mua sắm - ${new Date().toLocaleDateString('vi-VN')}`,
      items: items || [],
      plannedDate: plannedDate || new Date(),
      status: 'draft',
      isAutoGenerated: false
    });

    await shoppingList.populate([
      { path: 'items.foodItemId', select: 'name categoryId image' },
      { path: 'items.unitId', select: 'name abbreviation' }
    ]);

    // Tự động tạo notification cho family members (nếu có familyGroupId)
    if (shoppingList.familyGroupId) {
      try {
        await notificationService.notifyNewShoppingList(shoppingList._id);
      } catch (error) {
        // Log error nhưng không fail request
        console.error('Error notifying family members:', error);
      }
    }

    res.status(201).json({
      success: true,
      message: 'Tạo danh sách mua sắm thành công',
      data: {
        shoppingList
      }
    });
  } catch (error) {
    next(error);
  }
};

/**
 * @desc    Cập nhật danh sách mua sắm
 * @route   PUT /api/shopping-lists/:id
 * @access  Private
 */
exports.updateShoppingList = async (req, res, next) => {
  try {
    const shoppingList = await ShoppingList.findOne({
      _id: req.params.id,
      userId: req.user.id
    });

    if (!shoppingList) {
      return res.status(404).json({
        success: false,
        message: 'Không tìm thấy danh sách mua sắm'
      });
    }

    const { name, items, plannedDate, status } = req.body;

    if (name) shoppingList.name = name;
    if (items) shoppingList.items = items;
    if (plannedDate) shoppingList.plannedDate = plannedDate;
    if (status) shoppingList.status = status;

    await shoppingList.save();

    await shoppingList.populate([
      { path: 'items.foodItemId', select: 'name categoryId image' },
      { path: 'items.unitId', select: 'name abbreviation' }
    ]);

    res.json({
      success: true,
      message: 'Cập nhật danh sách mua sắm thành công',
      data: {
        shoppingList
      }
    });
  } catch (error) {
    next(error);
  }
};

/**
 * @desc    Xóa danh sách mua sắm
 * @route   DELETE /api/shopping-lists/:id
 * @access  Private
 */
exports.deleteShoppingList = async (req, res, next) => {
  try {
    const shoppingList = await ShoppingList.findOneAndDelete({
      _id: req.params.id,
      userId: req.user.id
    });

    if (!shoppingList) {
      return res.status(404).json({
        success: false,
        message: 'Không tìm thấy danh sách mua sắm'
      });
    }

    res.json({
      success: true,
      message: 'Xóa danh sách mua sắm thành công'
    });
  } catch (error) {
    next(error);
  }
};
